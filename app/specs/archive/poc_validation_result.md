# PoC 驗證結果報告

**日期**: 2025-11-09  
**任務**: Task 4.3.1 - 創建 PoC 閱讀器  
**狀態**: ✅ 完成（有重大限制）

---

## 📊 執行摘要

**結論**: 純 Flutter 方案（epubx + Text Widget）**技術可行但品質不佳**。

- ✅ 適合：簡單純文字 EPUB
- ⚠️ 限制：複雜 HTML 結構的精確分頁
- ❌ 不適合：專業級直書閱讀體驗

**建議**: 採用 **Readium Kotlin 混合方案**（Flutter UI + Android 原生閱讀核心）

---

## 🎯 驗證目標

驗證以下技術棧的可行性：
- `epubx ^4.0.0` - EPUB 解析
- `PageView` - 橫書分頁容器
- `flutter_html` / Text Widget - 內容渲染

---

## ✅ 成功實現的功能

### 1. EPUB 解析
- ✅ 使用 epubx 成功解析 EPUB3 文件
- ✅ 測試文件：《一夢漫言》（459KB, 1章節）
- ✅ 章節標題、HTML 內容提取正常

### 2. 分頁翻頁
- ✅ PageView 實現流暢的左右翻頁
- ✅ 頁碼顯示（x/總頁數）
- ✅ 基本分頁計算可用

### 3. 字體調整
- ✅ 動態字體大小（12-32px）
- ✅ 即時重新計算分頁
- ✅ 測試結果：
  - 12px: 124 頁
  - 14px: 104 頁
  - 16px: 85 頁
  - 18px: 68-69 頁

### 4. 內容渲染
- ✅ 純文字渲染（Text Widget）
- ✅ 過濾導航元素（"開始"、"目錄"等）
- ✅ HTML 實體解碼

---

## ⚠️ 遇到的問題

### 問題 1: 導航詞每頁出現
- **現象**: "開始" 字樣在每一頁都出現
- **原因**: HTML 中包含導航連結
- **解決**: 添加導航詞過濾列表
- **狀態**: ✅ 已解決

### 問題 2: 內容溢出需要滾動
- **現象**: 每頁內容超過螢幕，需要向下滾動
- **原因**: 分頁計算過於樂觀
- **解決**: 保守估算（80% 緩衝）+ 移除 ScrollView
- **狀態**: ✅ 已解決

### 問題 3: 字體變化未考量
- **現象**: 改變字體大小後，分頁錯亂
- **原因**: 固定的 `_fontSize`
- **解決**: 動態重新計算分頁
- **狀態**: ✅ 已解決

### 問題 4: 最後一行被切斷
- **現象**: 頁面最後一行文字被工具欄遮擋
- **原因**: 底部空間預留不足
- **解決**: 調整底部工具欄預留空間（60px → 80px）
- **狀態**: ✅ 已解決

### 問題 5: 分頁連貫性差 ⚠️
- **現象**: 翻頁後內容在句子中間斷開，閱讀不連貫
- **原因**: 按固定字數切割，忽略語義邊界
- **嘗試方案**:
  1. ✅ 智能切割點查找（標點符號優先）
  2. ✅ 保留 HTML 結構（標題 → 換行符）
  3. ✅ 基於行數的分頁算法
- **狀態**: ⚠️ **部分改善，但未完全解決**

### 問題 6: HTML 標籤影響分頁 ❌
- **現象**: 電子書中的 `<h1>`, `<h2>` 等標題標籤實際渲染高度不同
- **原因**: 純文字方案無法精確計算 HTML 渲染高度
- **嘗試方案**: 將標題轉換為換行符來模擬
- **狀態**: ❌ **根本性問題，無法完美解決**

---

## 📈 性能表現

### 加載時間
- EPUB 解析: < 200ms
- 分頁計算: < 300ms
- 總加載時間: < 500ms
- **評價**: ✅ 優秀

### 運行流暢度
- 翻頁動畫: 60fps
- 字體調整響應: 即時
- **評價**: ✅ 優秀

### 內存使用
- 未詳細測試
- **評價**: 需要進一步驗證

---

## 🔍 技術棧評估

### epubx ^4.0.0
- **解析能力**: ✅ 優秀
- **穩定性**: ✅ 可靠
- **API 易用性**: ✅ 良好
- **評分**: ⭐⭐⭐⭐⭐

### PageView
- **翻頁流暢度**: ✅ 原生級
- **手勢支持**: ✅ 完整
- **自定義能力**: ✅ 靈活
- **評分**: ⭐⭐⭐⭐⭐

### Text Widget (純文字渲染)
- **渲染速度**: ✅ 極快
- **格式支持**: ❌ 無（純文字）
- **分頁精度**: ⚠️ 有限
- **評分**: ⭐⭐⭐

### flutter_html ^3.0.0-beta.2
- **狀態**: 未使用（改用 Text Widget）
- **原因**: 過於複雜，難以精確分頁
- **評分**: N/A

---

## 📋 技術方案比較

### 方案 A: 純 Flutter（當前 PoC）

**技術棧**: Flutter + epubx + Text Widget

**優點**:
- ✅ 完全跨平台
- ✅ 代碼統一
- ✅ 性能優秀
- ✅ 開發速度快

**缺點**:
- ❌ 分頁精度不足
- ❌ HTML 格式支持有限
- ❌ 無法處理複雜排版
- ❌ 直書支持需要大量自定義

**適用場景**:
- 簡單純文字 EPUB
- 無複雜排版需求
- 可接受一定品質妥協

---

### 方案 B: Readium Kotlin 混合（推薦）

**技術棧**: Flutter UI + Platform Channel + Readium Kotlin

**優點**:
- ✅ 專業級直書橫書支援
- ✅ 完整 EPUB3 規範支援
- ✅ 成熟穩定（100+ 應用使用）
- ✅ 活躍維護
- ✅ 完整文檔和範例

**缺點**:
- ⚠️ 需要維護 Kotlin 代碼
- ⚠️ 跨平台需要額外工作（iOS 用 Readium Swift）
- ⚠️ 學習曲線

**適用場景**:
- 專業閱讀器應用
- 需要完整直書支持
- 追求最佳用戶體驗

**參考資源**:
- 官網: https://readium.org/kotlin-toolkit/
- GitHub: https://github.com/readium/kotlin-toolkit
- 範例: R2 Reader Android

---

## 💡 最終建議

### 對 ShuyuanReader 的建議

#### 短期（1-2週）
1. ✅ **完成當前 PoC 文檔整理**
2. ⬜ 研究 Readium Kotlin 整合方案
3. ⬜ 創建 Platform Channel 架構設計
4. ⬜ 評估開發成本和時間

#### 中期（1-2個月）
1. ⬜ 實現 Flutter ↔ Readium Kotlin 通訊
2. ⬜ 實現基本的直書閱讀功能
3. ⬜ 遷移現有橫書功能到 Readium
4. ⬜ 測試和優化

#### 長期（3-6個月）
1. ⬜ 實現標註、書籤、字典等進階功能
2. ⬜ 考慮 iOS 版本（Readium Swift）
3. ⬜ 優化性能和用戶體驗
4. ⬜ 發布正式版本

---

## 🎯 決策點

**關鍵問題**: 是否採用 Readium Kotlin？

**如果 YES（推薦）**:
- ➡️ 開始學習 Readium Kotlin
- ➡️ 設計 Platform Channel 架構
- ➡️ 創建 Kotlin 整合層
- ➡️ 逐步遷移功能

**如果 NO（繼續純 Flutter）**:
- ➡️ 接受分頁品質限制
- ➡️ 專注簡單文字書籍
- ➡️ 投入大量時間自繪直書
- ➡️ 長期維護成本高

---

## 📁 相關代碼

**PoC 實現文件**:
- `lib/presentation/pages/reader/reader_page_poc.dart` (601 行)

**核心方法**:
- `_loadBook()` - 從 Hive 加載書籍
- `_calculatePages()` - 主分頁邏輯
- `_extractTextContent()` - HTML → 純文字（保留結構）
- `_splitIntoLogicalLines()` - 文字 → 邏輯行
- `_endsWithSentence()` - 判斷句子結尾
- `_recalculatePages()` - 字體變化重算

**Git 分支**: `feature/reader-refactor`

---

## 📝 總結

Task 4.3.1 PoC 驗證**成功證明了純 Flutter 方案的技術可行性**，但也暴露了**品質不足的問題**。

對於古籍閱讀器 ShuyuanReader 來說，直書閱讀是核心功能，**建議採用 Readium Kotlin 混合方案**以獲得：
- 專業級的直書橫書支援
- 完整的 EPUB3 規範支援
- 最佳的用戶閱讀體驗

純 Flutter 方案可以作為**橫書閱讀的備選方案**或**臨時解決方案**，但不建議作為直書閱讀的長期方案。

---

**報告撰寫者**: GitHub Copilot  
**審核狀態**: 待用戶確認  
**下一步行動**: 等待決策 - 採用 Readium Kotlin 或繼續優化 Flutter 方案
