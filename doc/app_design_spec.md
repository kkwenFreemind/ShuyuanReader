# æ›¸è‹‘é–±è®€å™¨ App æŠ€è¡“è¨­è¨ˆæ–‡æª”

## ç›®éŒ„
1. [ç³»çµ±æ¶æ§‹æ¦‚è¦½](#1-ç³»çµ±æ¶æ§‹æ¦‚è¦½)
2. [åŠŸèƒ½æ“´å±•èˆ‡ç”¨æˆ¶é«”é©—](#2-åŠŸèƒ½æ“´å±•èˆ‡ç”¨æˆ¶é«”é©—)
3. [æŠ€è¡“å¯¦ç¾èˆ‡æ€§èƒ½](#3-æŠ€è¡“å¯¦ç¾èˆ‡æ€§èƒ½)
4. [å®‰å…¨æ€§èˆ‡åˆè¦](#4-å®‰å…¨æ€§èˆ‡åˆè¦)
5. [æ¸¬è©¦èˆ‡éƒ¨ç½²](#5-æ¸¬è©¦èˆ‡éƒ¨ç½²)
6. [æŠ€è¡“æ¶æ§‹](#6-æŠ€è¡“æ¶æ§‹)
7. [é–‹ç™¼è·¯ç·šåœ–](#7-é–‹ç™¼è·¯ç·šåœ–)

---

## 1. ç³»çµ±æ¶æ§‹æ¦‚è¦½

### 1.1 æ ¸å¿ƒè¨­è¨ˆç†å¿µ

**æ›¸è‹‘é–±è®€å™¨æ¡ç”¨ã€Œé›²ç«¯å…§å®¹æº + æœ¬åœ°ç·©å­˜ã€çš„æ¶æ§‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         GitHub Repository (å…§å®¹æº)           â”‚
â”‚  https://github.com/kkwenFreemind/         â”‚
â”‚  ShuyuanReader                              â”‚
â”‚                                             â”‚
â”‚  ğŸ“ catalog/books.json    â† æ›¸ç±å…ƒæ•¸æ“š       â”‚
â”‚  ğŸ“ covers/*.png          â† 100+ å°é¢åœ–ç‰‡    â”‚
â”‚  ğŸ“ epub3/*.epub          â† 100+ é›»å­æ›¸      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ HTTPS ä¸‹è¼‰
              â†“ æŒ‰éœ€ç²å–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Android APP (æ™ºèƒ½ç·©å­˜å±¤)             â”‚
â”‚                                             â”‚
â”‚  ğŸ—„ï¸  Hive æ•¸æ“šåº«     â† æ›¸ç±å…ƒæ•¸æ“š + ç‹€æ…‹     â”‚
â”‚  ğŸ“¦  files/books/   â† ç”¨æˆ¶ä¸‹è¼‰çš„ EPUB       â”‚
â”‚  ğŸ–¼ï¸  cache/covers/  â† è‡ªå‹•ç·©å­˜çš„å°é¢         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è³‡æºå­˜æ”¾èªªæ˜

| è³‡æºé¡å‹ | å­˜æ”¾ä½ç½® | å¤§å° | ä¸‹è¼‰æ™‚æ©Ÿ | ä¿å­˜æœŸé™ |
|---------|---------|------|---------|---------|
| **books.json** | GitHub + APP ç·©å­˜ | 50 KB | å•Ÿå‹•æ™‚ | 24 å°æ™‚ |
| **å°é¢åœ–ç‰‡** | GitHub + APP ç·©å­˜ | 50-200 KB/å¼µ | ç€è¦½æ™‚ | 7 å¤© |
| **EPUB æ–‡ä»¶** | GitHub + ç”¨æˆ¶ä¸‹è¼‰ | 1-5 MB/æœ¬ | ç”¨æˆ¶ä¸»å‹•ä¸‹è¼‰ | æ°¸ä¹…ï¼ˆç›´åˆ°åˆªé™¤ï¼‰|

### 1.3 ç”¨æˆ¶ä½¿ç”¨æµç¨‹

```
é¦–æ¬¡å•Ÿå‹•
  â†“
ä¸‹è¼‰ books.json (50KB)
  â†“
é¡¯ç¤ºæ›¸ç±åˆ—è¡¨ï¼ˆ100+æœ¬æ›¸ï¼‰
  â†“
ç”¨æˆ¶ç€è¦½åˆ—è¡¨
  â†“
è‡ªå‹•ä¸‹è¼‰ä¸¦ç·©å­˜å°é¢åœ–ç‰‡
  â†“
ç”¨æˆ¶é»æ“Šã€Œä¸‹è¼‰ã€æŒ‰éˆ•
  â†“
å¾ GitHub ä¸‹è¼‰å®Œæ•´ EPUB (1-5MB)
  â†“
ä¿å­˜åˆ°æœ¬åœ°æ°¸ä¹…å­˜å„²
  â†“
ç”¨æˆ¶å¯é›¢ç·šé–±è®€
```

### 1.4 ç‚ºä»€éº¼é¸æ“‡é€™ç¨®æ¶æ§‹ï¼Ÿ

âœ… **å°é–‹ç™¼è€…çš„å„ªå‹¢**ï¼š
- ç„¡éœ€ç¶­è­·æœå‹™å™¨ï¼ˆé›¶æˆæœ¬ï¼‰
- ä½¿ç”¨ Git ç®¡ç†å…§å®¹ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
- GitHub æä¾›å…¨çƒ CDNï¼ˆé«˜å¯ç”¨æ€§ï¼‰

âœ… **å°ç”¨æˆ¶çš„å„ªå‹¢**ï¼š
- APP é«”ç©å°ï¼ˆä¸å…§åµŒä»»ä½•æ›¸ç±ï¼‰
- æŒ‰éœ€ä¸‹è¼‰ï¼ˆç¯€çœæµé‡å’Œç©ºé–“ï¼‰
- é›¢ç·šå¯ç”¨ï¼ˆå·²ä¸‹è¼‰å…§å®¹ï¼‰

âœ… **æŠ€è¡“å„ªå‹¢**ï¼š
- å…§å®¹å’Œä»£ç¢¼åˆ†é›¢
- æ˜“æ–¼æ“´å±•ï¼ˆæ·»åŠ æ–°æ›¸åªéœ€ git pushï¼‰
- æ”¯æŒå¢é‡æ›´æ–°

> ğŸ“š **è©³ç´°çš„å­˜å„²æ¶æ§‹è¨­è¨ˆè«‹åƒé–±**ï¼š[storage_architecture.md](./storage_architecture.md)

---

## 2. åŠŸèƒ½æ“´å±•èˆ‡ç”¨æˆ¶é«”é©—

### 2.1 æ›¸ç±ç®¡ç†åŠŸèƒ½

#### è¨­è¨ˆæ–¹æ¡ˆï¼šæœ¬åœ°æ›¸ç±æ•¸æ“šåº«

> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**ï¼šAPP å¾ GitHub ç²å–æ›¸ç±åˆ—è¡¨ï¼ˆbooks.jsonï¼‰ï¼Œä¸¦å°‡å…ƒæ•¸æ“šå­˜å„²åœ¨æœ¬åœ° Hive æ•¸æ“šåº«ä¸­ã€‚ç”¨æˆ¶å¯ä»¥ç€è¦½æ‰€æœ‰æ›¸ç±ï¼Œä½†åªæœ‰ä¸‹è¼‰å¾Œæ‰èƒ½é–±è®€ã€‚

```yaml
æŠ€è¡“é¸å‹: 
  - Hive (è¼•é‡ç´š NoSQL æ•¸æ“šåº«)
  - å„ªé»: ç´” Dartã€å¿«é€Ÿã€é›¢ç·šæ”¯æŒ

æ•¸æ“šæ¨¡å‹:
  LocalBook:
    - id: String                  # å”¯ä¸€æ¨™è­˜
    - title: String               # æ›¸å
    - author: String              # ä½œè€…
    
    # â­ é ç¨‹è³‡æº URL (ä¾†è‡ª GitHub)
    - remoteEpubUrl: String       # GitHub ä¸Šçš„ EPUB URL
    - remoteCoverUrl: String      # GitHub ä¸Šçš„å°é¢ URL
    
    # â­ æœ¬åœ°è³‡æºè·¯å¾‘ (ä¸‹è¼‰å¾Œæ‰æœ‰)
    - localEpubPath: String?      # æœ¬åœ° EPUB çµ•å°è·¯å¾‘
    - localCoverPath: String?     # æœ¬åœ°å°é¢çµ•å°è·¯å¾‘
    
    # ä¸‹è¼‰ç‹€æ…‹
    - downloadStatus: enum        # notDownloaded, downloading, completed, error
    - downloadProgress: double    # 0.0 ~ 1.0
    
    # é–±è®€ç‹€æ…‹
    - readStatus: enum            # unread, reading, finished
    - lastReadPosition: String?   # é–±è®€é€²åº¦ (CFI)
    - lastReadTime: DateTime?
    - addedTime: DateTime
    
    # æ–‡ä»¶ä¿¡æ¯
    - fileSizeBytes: int?
    - md5Hash: String?            # æ–‡ä»¶å®Œæ•´æ€§æ ¡é©—
```

#### åŠŸèƒ½å¯¦ç¾
```dart
// æ›¸ç±ç®¡ç†æœå‹™
class BookManager {
  // 1. ç²å–æ‰€æœ‰æœ¬åœ°æ›¸ç±
  Future<List<LocalBook>> getLocalBooks({
    BookFilter? filter,
    BookSort? sort,
  });
  
  // 2. ä¸‹è¼‰ç®¡ç†
  Future<void> downloadBook(LocalBook book);
  Future<void> deleteBook(String bookId);
  Future<void> pauseDownload(String bookId);
  Future<void> resumeDownload(String bookId);
  
  // 3. ç‹€æ…‹ç®¡ç†
  Future<void> markAsRead(String bookId);
  Future<void> markAsUnread(String bookId);
  Future<void> updateReadingProgress(String bookId, String position);
  
  // 4. åŒæ­¥æª¢æŸ¥
  Future<SyncResult> checkForUpdates();
  Future<void> syncWithRemote();
}

enum BookFilter {
  all,
  downloaded,
  notDownloaded,
  reading,
  finished,
}

enum BookSort {
  titleAsc,
  titleDesc,
  authorAsc,
  authorDesc,
  addedTimeDesc,
  lastReadTimeDesc,
}
```

#### UI è¨­è¨ˆ
```
ä¸»é é¢ (HomePage)
â”œâ”€â”€ AppBar
â”‚   â”œâ”€â”€ æ¨™é¡Œ: "æ›¸è‹‘é–±è®€å™¨"
â”‚   â”œâ”€â”€ æœç´¢æŒ‰éˆ•
â”‚   â””â”€â”€ éæ¿¾/æ’åºæŒ‰éˆ•
â”œâ”€â”€ TabBar
â”‚   â”œâ”€â”€ å…¨éƒ¨æ›¸ç± (é ç¨‹ + æœ¬åœ°)
â”‚   â”œâ”€â”€ æœ¬åœ°æ›¸åº« (å·²ä¸‹è¼‰)
â”‚   â””â”€â”€ æ­£åœ¨é–±è®€
â””â”€â”€ Body
    â”œâ”€â”€ RefreshIndicator (ä¸‹æ‹‰åˆ·æ–°)
    â””â”€â”€ GridView/ListView
        â””â”€â”€ BookCard
            â”œâ”€â”€ å°é¢åœ–ç‰‡
            â”œâ”€â”€ ä¸‹è¼‰é€²åº¦æŒ‡ç¤ºå™¨
            â”œâ”€â”€ æ›¸å
            â”œâ”€â”€ ä½œè€…
            â””â”€â”€ ç‹€æ…‹æ¨™è¨˜ (æ–°æ›¸/å·²è®€/é–±è®€ä¸­)

æ›¸ç±è©³æƒ…é  (BookDetailPage)
â”œâ”€â”€ å°é¢å¤§åœ–
â”œâ”€â”€ æ›¸ç±ä¿¡æ¯ (æ¨™é¡Œã€ä½œè€…ã€èªè¨€ã€æè¿°)
â”œâ”€â”€ æ“ä½œæŒ‰éˆ•
â”‚   â”œâ”€â”€ ä¸‹è¼‰/æ‰“é–‹é–±è®€
â”‚   â”œâ”€â”€ åˆ†äº«
â”‚   â””â”€â”€ åˆªé™¤
â””â”€â”€ ç›¸é—œæ¨è–¦
```

### 1.2 æœç´¢èˆ‡éæ¿¾åŠŸèƒ½

#### å¯¦ç¾æ–¹æ¡ˆ
```dart
class SearchService {
  // 1. å…¨æ–‡æœç´¢
  List<LocalBook> searchBooks({
    required String query,
    SearchField field = SearchField.all,
  }) {
    // ä½¿ç”¨ Hive query + Dart String matching
    // æ”¯æŒä¸­æ–‡åˆ†è©ï¼ˆå¯é¸ï¼šä½¿ç”¨ jieba åˆ†è©åº«ï¼‰
  }
  
  // 2. é«˜ç´šéæ¿¾
  List<LocalBook> filterBooks({
    String? language,
    String? author,
    DateRange? dateRange,
    BookFilter? status,
  });
}

enum SearchField {
  all,
  title,
  author,
  description,
}
```

#### UI çµ„ä»¶
```dart
// æœç´¢é é¢
class SearchPage extends StatefulWidget {
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: SearchBar(
          hintText: 'æœç´¢æ›¸åã€ä½œè€…...',
          onChanged: (query) => _performSearch(query),
        ),
      ),
      body: Column(
        children: [
          // å¿«é€Ÿéæ¿¾æŒ‰éˆ•
          FilterChips(
            filters: ['å…¨éƒ¨', 'å·²ä¸‹è¼‰', 'æœªè®€', 'æ­£åœ¨è®€'],
          ),
          // æœç´¢çµæœ
          Expanded(
            child: SearchResultList(),
          ),
        ],
      ),
    );
  }
}

// éæ¿¾å’Œæ’åºå°è©±æ¡†
class FilterSortDialog extends StatelessWidget {
  // èªè¨€é¸æ“‡
  // ä½œè€…ç¯©é¸
  // æ’åºæ–¹å¼
  // ä¸‹è¼‰ç‹€æ…‹
}
```

### 1.3 é–±è®€å™¨å¢å¼·åŠŸèƒ½

#### æ ¸å¿ƒé–±è®€åŠŸèƒ½
```dart
class ReaderFeatures {
  // 1. æ›¸ç±¤ç®¡ç†
  List<Bookmark> bookmarks;
  Future<void> addBookmark(Bookmark bookmark);
  Future<void> deleteBookmark(String id);
  
  // 2. ç­†è¨˜å’Œé«˜äº®
  List<Highlight> highlights;
  Future<void> addHighlight(Highlight highlight);
  Future<void> addNote(String highlightId, String note);
  
  // 3. é–±è®€è¨­ç½®
  ReaderSettings settings;
  // - å­—é«”å¤§å°: 12-32px
  // - å­—é«”é¡å‹: ç³»çµ±/æ¥·é«”/å®‹é«”
  // - è¡Œè·: 1.0-2.0
  // - é é‚Šè·: å°/ä¸­/å¤§
  // - ä¸»é¡Œ: æ—¥é–“/å¤œé–“/è­·çœ¼/ç¾Šçš®ç´™
  // - ç¿»é æ–¹å¼: æ»‘å‹•/é»æ“Š/ä»¿çœŸ
  
  // 4. é€²åº¦è¿½è¹¤
  ReadingProgress progress;
  // - ç•¶å‰ä½ç½® (CFI)
  // - å·²è®€ç™¾åˆ†æ¯”
  // - é è¨ˆå‰©é¤˜æ™‚é–“
}

// æ•¸æ“šæ¨¡å‹
class Bookmark {
  String id;
  String bookId;
  String cfi;          // EPUB CFI (Canonical Fragment Identifier)
  String chapterTitle;
  String previewText;
  DateTime createdAt;
}

class Highlight {
  String id;
  String bookId;
  String cfi;
  String text;
  String color;        // yellow, green, blue, pink
  String? note;
  DateTime createdAt;
}

class ReaderSettings {
  double fontSize;
  String fontFamily;
  double lineHeight;
  int pageMargin;
  ThemeMode themeMode;
  PageTurnAnimation animation;
}
```

#### é–±è®€å™¨ UI çµæ§‹
```
ReaderPage
â”œâ”€â”€ AppBar (è‡ªå‹•éš±è—)
â”‚   â”œâ”€â”€ è¿”å›æŒ‰éˆ•
â”‚   â”œâ”€â”€ ç« ç¯€æ¨™é¡Œ
â”‚   â””â”€â”€ æ›´å¤šé¸é … (ç›®éŒ„/æ›¸ç±¤/è¨­ç½®)
â”œâ”€â”€ Body
â”‚   â”œâ”€â”€ GestureDetector (é»æ“Šé¡¯ç¤º/éš±è—èœå–®)
â”‚   â””â”€â”€ EPUBView (æ ¸å¿ƒé–±è®€è¦–åœ–)
â”‚       â”œâ”€â”€ PageView/SingleChildScrollView
â”‚       â””â”€â”€ SelectableText (æ”¯æŒé¸ä¸­å’Œé«˜äº®)
â”œâ”€â”€ BottomBar (è‡ªå‹•éš±è—)
â”‚   â”œâ”€â”€ é€²åº¦æ¢ Slider
â”‚   â”œâ”€â”€ ä¸Šä¸€ç« /ä¸‹ä¸€ç« 
â”‚   â””â”€â”€ é–±è®€é€²åº¦ç™¾åˆ†æ¯”
â””â”€â”€ æµ®å‹•èœå–®
    â”œâ”€â”€ ç›®éŒ„ Drawer
    â”œâ”€â”€ æ›¸ç±¤åˆ—è¡¨
    â”œâ”€â”€ ç­†è¨˜åˆ—è¡¨
    â””â”€â”€ è¨­ç½®é¢æ¿
        â”œâ”€â”€ å­—é«”èª¿æ•´
        â”œâ”€â”€ ä¸»é¡Œåˆ‡æ›
        â””â”€â”€ ç¿»é è¨­ç½®
```

### 1.4 å¤šèªè¨€/åœ‹éš›åŒ–æ”¯æŒ

#### å¯¦ç¾æ–¹æ¡ˆ
```yaml
æŠ€è¡“é¸å‹: flutter_localizations + intl

æ”¯æŒèªè¨€:
  - zh_TW: ç¹é«”ä¸­æ–‡ (é è¨­)
  - zh_CN: ç°¡é«”ä¸­æ–‡
  - en_US: è‹±æ–‡

æ–‡ä»¶çµæ§‹:
  lib/l10n/
    â”œâ”€â”€ app_zh_TW.arb
    â”œâ”€â”€ app_zh_CN.arb
    â””â”€â”€ app_en.arb
```

```dart
// ä½¿ç”¨ç¤ºä¾‹
MaterialApp(
  localizationsDelegates: [
    AppLocalizations.delegate,
    GlobalMaterialLocalizations.delegate,
    GlobalWidgetsLocalizations.delegate,
  ],
  supportedLocales: [
    Locale('zh', 'TW'),
    Locale('zh', 'CN'),
    Locale('en', 'US'),
  ],
);

// åœ¨ä»£ç¢¼ä¸­ä½¿ç”¨
Text(AppLocalizations.of(context)!.bookLibrary);
```

---

## 3. æŠ€è¡“å¯¦ç¾èˆ‡æ€§èƒ½

### 3.1 ä¸‹è¼‰èˆ‡å­˜å„²å„ªåŒ–

> ğŸ“Œ **æ ¸å¿ƒæµç¨‹**ï¼šå¾ GitHub Raw Content URL ä¸‹è¼‰è³‡æº â†’ ä¿å­˜åˆ° APP æœ¬åœ°å­˜å„² â†’ æ›´æ–° Hive æ•¸æ“šåº«ç‹€æ…‹

#### GitHub è³‡æº URL é…ç½®

```dart
class GitHubConfig {
  // GitHub Repository é…ç½®
  static const String owner = 'kkwenFreemind';
  static const String repo = 'ShuyuanReader';
  static const String branch = 'main';
  
  // Raw Content åŸºç¤ URL
  static const String baseUrl = 
    'https://raw.githubusercontent.com/$owner/$repo/$branch';
  
  // è³‡æºè·¯å¾‘
  static const String catalogPath = 'catalog/books.json';
  static const String coversPath = 'covers';
  static const String epubsPath = 'epub3';
  
  // å®Œæ•´ URL
  static String get catalogUrl => '$baseUrl/$catalogPath';
  
  static String getCoverUrl(String bookId) {
    return '$baseUrl/$coversPath/$bookId.png';
  }
  
  static String getEpubUrl(String filename) {
    return '$baseUrl/$epubsPath/$filename';
  }
}

// ä½¿ç”¨ç¤ºä¾‹
final booksJsonUrl = GitHubConfig.catalogUrl;
// https://raw.githubusercontent.com/kkwenFreemind/ShuyuanReader/main/catalog/books.json

final coverUrl = GitHubConfig.getCoverUrl('ä¸€å¤¢æ¼«è¨€');
// https://raw.githubusercontent.com/kkwenFreemind/ShuyuanReader/main/covers/ä¸€å¤¢æ¼«è¨€.png

final epubUrl = GitHubConfig.getEpubUrl('ä¸€å¤¢æ¼«è¨€.epub');
// https://raw.githubusercontent.com/kkwenFreemind/ShuyuanReader/main/epub3/ä¸€å¤¢æ¼«è¨€.epub
```

#### ä¸‹è¼‰ç®¡ç†å™¨è¨­è¨ˆ

```dart
class DownloadManager {
  final Dio dio;
  final StoragePathManager pathManager;
  final Map<String, CancelToken> _cancelTokens = {};
  final Map<String, DownloadTask> _tasks = {};
  
  // 1. ä¸‹è¼‰ EPUBï¼ˆå¾ GitHubï¼‰
  Future<void> downloadEPUB({
    required String bookId,
    required String remoteUrl,  // GitHub URL
    ProgressCallback? onProgress,
  }) async {
    // ç²å–æœ¬åœ°ä¿å­˜è·¯å¾‘
    final savePath = pathManager.getEpubPath(bookId);
    
    // æª¢æŸ¥æ˜¯å¦å·²ä¸‹è¼‰
    if (await pathManager.epubExists(bookId)) {
      print('EPUB å·²å­˜åœ¨: $savePath');
      return;
    }
    final cancelToken = CancelToken();
    _cancelTokens[bookId] = cancelToken;
    
    try {
      await dio.download(
        url,
        savePath,
        cancelToken: cancelToken,
        onReceiveProgress: (received, total) {
          final progress = received / total;
          onProgress?.call(progress);
          _updateDownloadProgress(bookId, progress);
        },
        options: Options(
          receiveTimeout: Duration(minutes: 10),
          headers: {
            'Accept-Encoding': 'gzip',
          },
        ),
      );
      
      // ä¸‹è¼‰å®Œæˆå¾Œé©—è­‰
      await _verifyDownload(savePath, bookId);
      
    } on DioException catch (e) {
      _handleDownloadError(bookId, e);
    }
  }
  
  // 2. æ–‡ä»¶æ ¡é©—
  Future<bool> _verifyDownload(String path, String bookId) async {
    final file = File(path);
    if (!await file.exists()) return false;
    
    // MD5 æ ¡é©— (å¯é¸ï¼šå¾æœå‹™å™¨ç²å–é æœŸ MD5)
    final bytes = await file.readAsBytes();
    final hash = md5.convert(bytes).toString();
    
    // ä¿å­˜ hash åˆ°æ•¸æ“šåº«
    await _saveFileHash(bookId, hash);
    
    return true;
  }
  
  // 3. æš«åœ/æ¢å¾©/å–æ¶ˆ
  void pauseDownload(String bookId) {
    _cancelTokens[bookId]?.cancel('Paused by user');
  }
  
  Future<void> resumeDownload(String bookId) async {
    // å¯¦ç¾æ–·é»çºŒå‚³
    final task = _tasks[bookId];
    if (task != null) {
      await downloadEPUB(
        url: task.url,
        savePath: task.savePath,
        bookId: bookId,
        onProgress: task.onProgress,
      );
    }
  }
  
  // 4. å¾Œå°ä¸‹è¼‰ (Android)
  Future<void> downloadInBackground(List<String> bookIds) async {
    // ä½¿ç”¨ flutter_downloader
    // æˆ–è€… WorkManager (Android) + BackgroundFetch (iOS)
  }
}

// ä¸‹è¼‰ä»»å‹™æ¨¡å‹
class DownloadTask {
  String bookId;
  String url;
  String savePath;
  DownloadStatus status;
  double progress;
  int? totalBytes;
  int? downloadedBytes;
  DateTime? startTime;
  DateTime? endTime;
  String? errorMessage;
  ProgressCallback? onProgress;
}

enum DownloadStatus {
  pending,
  downloading,
  paused,
  completed,
  failed,
  cancelled,
}
```

#### å­˜å„²ç­–ç•¥
```dart
class StorageManager {
  // 1. è·¯å¾‘ç®¡ç†
  Future<Directory> getAppDocDir() async {
    return await getApplicationDocumentsDirectory();
  }
  
  String getEPUBPath(String bookId) {
    return '${appDocDir.path}/books/$bookId.epub';
  }
  
  String getCoverPath(String bookId) {
    return '${appDocDir.path}/covers/$bookId.png';
  }
  
  // 2. ç©ºé–“ç®¡ç†
  Future<StorageInfo> getStorageInfo() async {
    final appDir = await getAppDocDir();
    int totalSize = 0;
    int bookCount = 0;
    
    // è¨ˆç®—æ‰€æœ‰ EPUB æ–‡ä»¶å¤§å°
    final booksDir = Directory('${appDir.path}/books');
    if (await booksDir.exists()) {
      await for (var file in booksDir.list()) {
        if (file is File) {
          totalSize += await file.length();
          bookCount++;
        }
      }
    }
    
    return StorageInfo(
      totalSize: totalSize,
      bookCount: bookCount,
      availableSpace: await _getAvailableSpace(),
    );
  }
  
  // 3. æ¸…ç†åŠŸèƒ½
  Future<void> clearCache() async {
    // æ¸…é™¤è‡¨æ™‚æ–‡ä»¶å’Œå°é¢ç·©å­˜
  }
  
  Future<void> deleteBook(String bookId) async {
    final epubFile = File(getEPUBPath(bookId));
    final coverFile = File(getCoverPath(bookId));
    
    if (await epubFile.exists()) await epubFile.delete();
    if (await coverFile.exists()) await coverFile.delete();
  }
}

class StorageInfo {
  int totalSize;          // bytes
  int bookCount;
  int availableSpace;     // bytes
  
  String get formattedSize => _formatBytes(totalSize);
  bool get isSpaceLow => availableSpace < 100 * 1024 * 1024; // < 100MB
}
```

### 2.2 ç·©å­˜èˆ‡é›¢ç·šæ¨¡å¼

#### ç·©å­˜ç­–ç•¥
```dart
class CacheManager {
  // 1. books.json ç·©å­˜
  Future<void> cacheBooksJson(String json) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('books_json', json);
    await prefs.setString('books_json_timestamp', 
      DateTime.now().toIso8601String());
  }
  
  Future<String?> getCachedBooksJson() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString('books_json');
  }
  
  Future<bool> isCacheValid({Duration maxAge = const Duration(hours: 24)}) async {
    final prefs = await SharedPreferences.getInstance();
    final timestampStr = prefs.getString('books_json_timestamp');
    if (timestampStr == null) return false;
    
    final timestamp = DateTime.parse(timestampStr);
    return DateTime.now().difference(timestamp) < maxAge;
  }
  
  // 2. å°é¢åœ–ç‰‡ç·©å­˜
  Future<void> cacheImage(String url, String bookId) async {
    final cacheDir = await getTemporaryDirectory();
    final path = '${cacheDir.path}/covers/$bookId.png';
    
    await dio.download(url, path);
  }
  
  Future<File?> getCachedImage(String bookId) async {
    final cacheDir = await getTemporaryDirectory();
    final file = File('${cacheDir.path}/covers/$bookId.png');
    
    return await file.exists() ? file : null;
  }
}

// é›¢ç·šæ¨¡å¼è™•ç†
class OfflineManager {
  Future<void> checkConnectivity() async {
    final connectivity = await Connectivity().checkConnectivity();
    _isOnline = connectivity != ConnectivityResult.none;
  }
  
  Future<CatalogData> loadCatalog() async {
    if (_isOnline) {
      try {
        // å˜—è©¦å¾ç¶²çµ¡åŠ è¼‰
        final json = await _fetchRemoteCatalog();
        await _cacheManager.cacheBooksJson(json);
        return _parseCatalog(json);
      } catch (e) {
        // ç¶²çµ¡å¤±æ•—ï¼Œå›é€€åˆ°ç·©å­˜
        return await _loadCachedCatalog();
      }
    } else {
      // é›¢ç·šæ¨¡å¼ï¼Œç›´æ¥ä½¿ç”¨ç·©å­˜
      return await _loadCachedCatalog();
    }
  }
  
  Future<CatalogData> _loadCachedCatalog() async {
    final cached = await _cacheManager.getCachedBooksJson();
    if (cached != null) {
      return _parseCatalog(cached);
    }
    throw Exception('ç„¡ç·©å­˜æ•¸æ“šï¼Œè«‹é€£æ¥ç¶²çµ¡å¾Œé‡è©¦');
  }
}
```

#### æ›´æ–°æª¢æ¸¬æ©Ÿåˆ¶
```dart
class UpdateChecker {
  // 1. ä½¿ç”¨ ETag æª¢æ¸¬æ›´æ–°
  Future<bool> hasUpdates() async {
    final prefs = await SharedPreferences.getInstance();
    final savedETag = prefs.getString('books_json_etag');
    
    final response = await dio.head(
      'https://github.com/kkwenFreemind/ShuyuanReader/blob/main/catalog/books.json',
    );
    
    final currentETag = response.headers['etag']?.first;
    
    return currentETag != null && currentETag != savedETag;
  }
  
  // 2. ä½¿ç”¨ Last-Modified æª¢æ¸¬
  Future<bool> hasUpdatesLastModified() async {
    final prefs = await SharedPreferences.getInstance();
    final savedTime = prefs.getString('books_json_last_modified');
    
    final response = await dio.head(catalogUrl);
    final lastModified = response.headers['last-modified']?.first;
    
    return lastModified != null && lastModified != savedTime;
  }
  
  // 3. æ¯”è¼ƒç‰ˆæœ¬è™Ÿï¼ˆå¦‚æœ books.json åŒ…å«ç‰ˆæœ¬å­—æ®µï¼‰
  Future<bool> hasUpdatesVersion() async {
    final cached = await _cacheManager.getCachedBooksJson();
    if (cached == null) return true;
    
    final cachedData = jsonDecode(cached);
    final cachedVersion = cachedData['metadata']['version'];
    
    final remote = await _fetchRemoteCatalog();
    final remoteData = jsonDecode(remote);
    final remoteVersion = remoteData['metadata']['version'];
    
    return remoteVersion != cachedVersion;
  }
  
  // 4. è‡ªå‹•æ›´æ–°é€šçŸ¥
  Future<void> checkAndNotify() async {
    if (await hasUpdates()) {
      // é¡¯ç¤º SnackBar æˆ–å°è©±æ¡†
      _showUpdateDialog();
    }
  }
}
```

### 2.3 æ€§èƒ½èˆ‡å…§å­˜ç®¡ç†

#### æ‡¶åŠ è¼‰å’Œåˆ†é 
```dart
class BookListController extends GetxController {
  final int pageSize = 20;
  int currentPage = 0;
  List<LocalBook> books = [];
  bool isLoading = false;
  bool hasMore = true;
  
  Future<void> loadMore() async {
    if (isLoading || !hasMore) return;
    
    isLoading = true;
    
    try {
      final newBooks = await _bookManager.getBooks(
        offset: currentPage * pageSize,
        limit: pageSize,
      );
      
      if (newBooks.length < pageSize) {
        hasMore = false;
      }
      
      books.addAll(newBooks);
      currentPage++;
      
    } finally {
      isLoading = false;
      update();
    }
  }
}

// GridView å¯¦ç¾
class BookGridView extends StatelessWidget {
  Widget build(BuildContext context) {
    return GridView.builder(
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 3,
        childAspectRatio: 0.7,
      ),
      itemCount: controller.books.length + (controller.hasMore ? 1 : 0),
      itemBuilder: (context, index) {
        if (index == controller.books.length) {
          // åŠ è¼‰æ›´å¤šæŒ‡ç¤ºå™¨
          controller.loadMore();
          return LoadingIndicator();
        }
        
        return BookCard(book: controller.books[index]);
      },
    );
  }
}
```

#### åœ–ç‰‡å„ªåŒ–
```dart
class ImageCacheManager {
  // ä½¿ç”¨ cached_network_image
  Widget buildCoverImage(String url, String bookId) {
    return CachedNetworkImage(
      imageUrl: url,
      cacheKey: bookId,
      placeholder: (context, url) => ShimmerPlaceholder(),
      errorWidget: (context, url, error) => DefaultCoverImage(),
      memCacheWidth: 300,  // é™åˆ¶å…§å­˜ä¸­çš„åœ–ç‰‡å¯¬åº¦
      memCacheHeight: 400,
      maxWidthDiskCache: 600,
      maxHeightDiskCache: 800,
      fadeInDuration: Duration(milliseconds: 300),
    );
  }
  
  // é åŠ è¼‰å°é¢ï¼ˆåœ¨å¾Œå°ï¼‰
  Future<void> preloadCovers(List<String> urls) async {
    for (var url in urls) {
      await precacheImage(
        CachedNetworkImageProvider(url),
        context,
      );
    }
  }
}
```

#### EPUB è§£æå„ªåŒ–
```dart
class EPUBParser {
  // 1. æµå¼è§£æï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è¼‰æ•´å€‹æ–‡ä»¶
  Stream<Chapter> parseChapters(String epubPath) async* {
    final archive = ZipDecoder().decodeBuffer(
      await File(epubPath).readAsBytes(),
    );
    
    // é€ç« è§£æä¸¦ yield
    for (var chapter in _extractChapters(archive)) {
      yield chapter;
    }
  }
  
  // 2. æŒ‰éœ€åŠ è¼‰ç« ç¯€å…§å®¹
  Future<String> loadChapterContent(String epubPath, String chapterHref) async {
    // åªè§£æéœ€è¦çš„ç« ç¯€
    final archive = ZipDecoder().decodeBuffer(
      await File(epubPath).readAsBytes(),
    );
    
    final file = archive.findFile(chapterHref);
    if (file == null) throw Exception('Chapter not found');
    
    return utf8.decode(file.content);
  }
  
  // 3. ç·©å­˜è§£æçµæœ
  final Map<String, EPUBMetadata> _metadataCache = {};
  
  Future<EPUBMetadata> getMetadata(String epubPath) async {
    if (_metadataCache.containsKey(epubPath)) {
      return _metadataCache[epubPath]!;
    }
    
    final metadata = await _parseMetadata(epubPath);
    _metadataCache[epubPath] = metadata;
    
    return metadata;
  }
}
```

---

## 3. å®‰å…¨æ€§èˆ‡åˆè¦

### 3.1 æ•¸æ“šå®‰å…¨

#### HTTPS å’Œæ ¡é©—
```dart
class SecureDownloader {
  // 1. å¼·åˆ¶ HTTPS
  late Dio dio;
  
  SecureDownloader() {
    dio = Dio(BaseOptions(
      baseUrl: 'https://github.com',
      connectTimeout: Duration(seconds: 10),
      receiveTimeout: Duration(seconds: 30),
    ));
    
    // æ·»åŠ è­‰æ›¸å›ºå®š (Certificate Pinning)
    dio.httpClientAdapter = IOHttpClientAdapter(
      createHttpClient: () {
        final client = HttpClient();
        client.badCertificateCallback = (cert, host, port) {
          // é©—è­‰è­‰æ›¸
          return _verifyCertificate(cert, host);
        };
        return client;
      },
    );
  }
  
  // 2. æ–‡ä»¶å®Œæ•´æ€§é©—è­‰
  Future<bool> verifyFileIntegrity(
    String filePath,
    String expectedHash,
  ) async {
    final file = File(filePath);
    final bytes = await file.readAsBytes();
    final actualHash = sha256.convert(bytes).toString();
    
    return actualHash == expectedHash;
  }
  
  // 3. æ•¸å­—ç°½åé©—è­‰ (å¯é¸)
  Future<bool> verifySignature(
    String filePath,
    String signature,
    String publicKey,
  ) async {
    // ä½¿ç”¨ pointycastle é€²è¡Œ RSA é©—è­‰
    // å¯¦ç¾ç•¥
  }
}
```

#### æœ¬åœ°æ•¸æ“šåŠ å¯†
```dart
class SecureStorage {
  // ä½¿ç”¨ flutter_secure_storage å­˜å„²æ•æ„Ÿæ•¸æ“š
  final FlutterSecureStorage _storage = FlutterSecureStorage();
  
  // å­˜å„²ç”¨æˆ¶è¨­ç½®
  Future<void> saveUserPreference(String key, String value) async {
    await _storage.write(key: key, value: value);
  }
  
  // EPUB æ–‡ä»¶åŠ å¯† (å¯é¸)
  Future<void> encryptEPUB(String path) async {
    final file = File(path);
    final bytes = await file.readAsBytes();
    
    // ä½¿ç”¨ AES åŠ å¯†
    final encrypted = _encrypt(bytes);
    await file.writeAsBytes(encrypted);
  }
}
```

### 3.2 éš±ç§ä¿è­·

#### éš±ç§æ”¿ç­–å¯¦ç¾
```dart
class PrivacyManager {
  // 1. é¦–æ¬¡å•Ÿå‹•é¡¯ç¤ºéš±ç§æ”¿ç­–
  Future<bool> hasAcceptedPrivacyPolicy() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool('privacy_accepted') ?? false;
  }
  
  Future<void> acceptPrivacyPolicy() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('privacy_accepted', true);
    await prefs.setString('privacy_accepted_date', 
      DateTime.now().toIso8601String());
  }
  
  // 2. æ•¸æ“šæ”¶é›†è²æ˜
  Map<String, bool> getDataCollectionSettings() {
    return {
      'usage_analytics': false,     // ä½¿ç”¨æƒ…æ³åˆ†æ
      'crash_reports': true,         // å´©æ½°å ±å‘Š
      'performance_monitoring': false, // æ€§èƒ½ç›£æ§
    };
  }
  
  // 3. æ•¸æ“šåˆªé™¤è«‹æ±‚
  Future<void> deleteAllUserData() async {
    // åˆªé™¤æ‰€æœ‰æœ¬åœ°æ•¸æ“š
    await _deleteLocalBooks();
    await _deleteUserPreferences();
    await _deleteCache();
  }
}
```

#### Android æ¬Šé™ç®¡ç†
```dart
class PermissionManager {
  // 1. å­˜å„²æ¬Šé™ (Android 10+)
  Future<bool> requestStoragePermission() async {
    if (await Permission.storage.isGranted) {
      return true;
    }
    
    final status = await Permission.storage.request();
    
    if (status.isPermanentlyDenied) {
      await openAppSettings();
    }
    
    return status.isGranted;
  }
  
  // 2. é€šçŸ¥æ¬Šé™ (ç”¨æ–¼ä¸‹è¼‰å®Œæˆé€šçŸ¥)
  Future<bool> requestNotificationPermission() async {
    if (await Permission.notification.isGranted) {
      return true;
    }
    
    return (await Permission.notification.request()).isGranted;
  }
}

// AndroidManifest.xml é…ç½®
/*
<uses-permission android:name="android.permission.INTERNET"/>
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
    android:maxSdkVersion="28"/>
<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
*/
```

### 3.3 ç‰ˆæ¬Šèˆ‡åˆè¦

#### å…è²¬è²æ˜
```dart
class LegalNotice {
  static const String disclaimer = '''
æ›¸è‹‘é–±è®€å™¨ - å…è²¬è²æ˜

1. å…§å®¹ä¾†æº
   æœ¬æ‡‰ç”¨ä¸­çš„é›»å­æ›¸å…§å®¹ä¾†è‡ªå…¬é–‹çš„ GitHub å€‰åº«ï¼Œåƒ…ä¾›å­¸ç¿’å’Œç ”ç©¶ä½¿ç”¨ã€‚

2. ç‰ˆæ¬Šè²æ˜
   æ‰€æœ‰æ›¸ç±ç‰ˆæ¬Šæ­¸åŸä½œè€…æ‰€æœ‰ã€‚å¦‚æœ‰ä¾µæ¬Šï¼Œè«‹è¯ç¹«æˆ‘å€‘åˆªé™¤ã€‚

3. ä½¿ç”¨é™åˆ¶
   ç”¨æˆ¶ä¸å¾—å°‡æœ¬æ‡‰ç”¨ä¸­çš„å…§å®¹ç”¨æ–¼å•†æ¥­ç”¨é€”æˆ–é€²è¡ŒäºŒæ¬¡åˆ†ç™¼ã€‚

4. è²¬ä»»é™åˆ¶
   æœ¬æ‡‰ç”¨é–‹ç™¼è€…ä¸å°å…§å®¹çš„æº–ç¢ºæ€§ã€å®Œæ•´æ€§æˆ–åˆæ³•æ€§æ‰¿æ“”è²¬ä»»ã€‚

è¯ç¹«æ–¹å¼: [email]

æœ€å¾Œæ›´æ–°: 2025-11-06
''';

  static void showDisclaimer(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('å…è²¬è²æ˜'),
        content: SingleChildScrollView(
          child: Text(disclaimer),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('æˆ‘å·²é–±è®€ä¸¦åŒæ„'),
          ),
        ],
      ),
    );
  }
}
```

#### å…§å®¹è©•ç´š
```yaml
# Google Play æ‡‰ç”¨è©•ç´šæº–å‚™
Content Rating:
  - Category: Books & Reference
  - Age Rating: Everyone
  - Content Descriptors: 
      - Educational Content
      - Traditional Chinese Literature
  - Privacy Policy URL: [å¾…æä¾›]
```

---

## 4. æ¸¬è©¦èˆ‡éƒ¨ç½²

### 4.1 éŒ¯èª¤è™•ç†

#### å…¨å±€éŒ¯èª¤æ•ç²
```dart
void main() {
  // 1. Flutter éŒ¯èª¤æ•ç²
  FlutterError.onError = (FlutterErrorDetails details) {
    FlutterError.presentError(details);
    _logError(details.exception, details.stack);
  };
  
  // 2. Dart ç•°æ­¥éŒ¯èª¤æ•ç²
  PlatformDispatcher.instance.onError = (error, stack) {
    _logError(error, stack);
    return true;
  };
  
  runZonedGuarded(
    () => runApp(MyApp()),
    (error, stackTrace) {
      _logError(error, stackTrace);
    },
  );
}

// éŒ¯èª¤æ—¥èªŒç³»çµ±
class ErrorLogger {
  static void logError(dynamic error, StackTrace? stackTrace) {
    // 1. æœ¬åœ°æ—¥èªŒ
    _writeToLocalLog(error, stackTrace);
    
    // 2. ä¸Šå ±åˆ°æœå‹™å™¨ (å¯é¸)
    if (kReleaseMode) {
      _reportToSentry(error, stackTrace);
    }
    
    // 3. é–‹ç™¼ç’°å¢ƒé¡¯ç¤ºè©³ç´°éŒ¯èª¤
    if (kDebugMode) {
      print('Error: $error\n$stackTrace');
    }
  }
  
  static Future<void> _reportToSentry(
    dynamic error,
    StackTrace? stackTrace,
  ) async {
    await Sentry.captureException(
      error,
      stackTrace: stackTrace,
    );
  }
}

// å‹å¥½éŒ¯èª¤æç¤º
class ErrorHandler {
  static String getUserFriendlyMessage(dynamic error) {
    if (error is DioException) {
      switch (error.type) {
        case DioExceptionType.connectionTimeout:
          return 'é€£æ¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡';
        case DioExceptionType.receiveTimeout:
          return 'æ¥æ”¶æ•¸æ“šè¶…æ™‚';
        case DioExceptionType.badResponse:
          return 'æœå‹™å™¨éŒ¯èª¤ (${error.response?.statusCode})';
        default:
          return 'ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦';
      }
    }
    
    if (error is FileSystemException) {
      return 'æ–‡ä»¶æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥å­˜å„²ç©ºé–“';
    }
    
    return 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤';
  }
  
  static void showErrorDialog(BuildContext context, dynamic error) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            Icon(Icons.error_outline, color: Colors.red),
            SizedBox(width: 8),
            Text('éŒ¯èª¤'),
          ],
        ),
        content: Text(getUserFriendlyMessage(error)),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('ç¢ºå®š'),
          ),
        ],
      ),
    );
  }
}
```

### 4.2 è·¨è¨­å‚™æ¸¬è©¦

#### éŸ¿æ‡‰å¼å¸ƒå±€
```dart
class ResponsiveBuilder extends StatelessWidget {
  final Widget Function(BuildContext, DeviceType) builder;
  
  @override
  Widget build(BuildContext context) {
    final deviceType = _getDeviceType(context);
    return builder(context, deviceType);
  }
  
  DeviceType _getDeviceType(BuildContext context) {
    final width = MediaQuery.of(context).size.width;
    
    if (width < 600) return DeviceType.mobile;
    if (width < 900) return DeviceType.tablet;
    return DeviceType.desktop;
  }
}

enum DeviceType { mobile, tablet, desktop }

// ä½¿ç”¨ç¤ºä¾‹
ResponsiveBuilder(
  builder: (context, deviceType) {
    switch (deviceType) {
      case DeviceType.mobile:
        return MobileLayout();
      case DeviceType.tablet:
        return TabletLayout();
      case DeviceType.desktop:
        return DesktopLayout();
    }
  },
);
```

#### å±å¹•é©é…
```dart
class ScreenAdapter {
  static double sp(double size) {
    // ä½¿ç”¨ flutter_screenutil
    return size.sp;
  }
  
  static double width(double size) {
    return size.w;
  }
  
  static double height(double size) {
    return size.h;
  }
}

// åˆå§‹åŒ–
ScreenUtil.init(
  designSize: Size(375, 812),  // iPhone X è¨­è¨ˆå°ºå¯¸
  minTextAdapt: true,
);
```

### 4.3 App ç”Ÿå‘½é€±æœŸç®¡ç†

#### Splash Screen
```dart
class SplashScreen extends StatefulWidget {
  @override
  _SplashScreenState createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen> {
  @override
  void initState() {
    super.initState();
    _initialize();
  }
  
  Future<void> _initialize() async {
    // 1. åˆå§‹åŒ–æ•¸æ“šåº«
    await _initDatabase();
    
    // 2. æª¢æŸ¥æ¬Šé™
    await _checkPermissions();
    
    // 3. åŠ è¼‰æ›¸ç±ç›®éŒ„
    await _loadCatalog();
    
    // 4. æª¢æŸ¥æ›´æ–°
    await _checkForUpdates();
    
    // 5. å°èˆªåˆ°ä¸»é 
    await Future.delayed(Duration(seconds: 2));
    Navigator.pushReplacement(
      context,
      MaterialPageRoute(builder: (context) => HomePage()),
    );
  }
}
```

#### é–±è®€é€²åº¦ä¿å­˜
```dart
class ReadingProgressManager {
  Timer? _saveTimer;
  
  void startAutoSave(String bookId, String Function() getCurrentPosition) {
    _saveTimer = Timer.periodic(
      Duration(seconds: 10),
      (_) async {
        final position = getCurrentPosition();
        await _saveProgress(bookId, position);
      },
    );
  }
  
  void stopAutoSave() {
    _saveTimer?.cancel();
  }
  
  @override
  void dispose() {
    stopAutoSave();
    super.dispose();
  }
}

// åœ¨ ReaderPage ä¸­ä½¿ç”¨
class ReaderPage extends StatefulWidget {
  @override
  void initState() {
    super.initState();
    _progressManager.startAutoSave(widget.bookId, _getCurrentCFI);
  }
  
  @override
  void dispose() {
    _progressManager.stopAutoSave();
    // æœ€å¾Œä¿å­˜ä¸€æ¬¡
    _saveProgress();
    super.dispose();
  }
}
```

---

## 5. æŠ€è¡“æ¶æ§‹

### 5.1 æ•´é«”æ¶æ§‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Presentation Layer             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Home   â”‚  Search  â”‚  Reader  â”‚ Settings â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                     GetX State Management         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Business Logic Layer            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ BookManager  â”‚DownloadMgr   â”‚ ReaderLogic â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ SearchSvc    â”‚ CacheMgr     â”‚ SyncService â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Hive DB      â”‚ SharedPrefs  â”‚ FileSystem  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Network (Dio)â”‚ Cache        â”‚ SecureStore â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é …ç›®çµæ§‹
```
lib/
â”œâ”€â”€ main.dart
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ routes/                 # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ themes/                 # ä¸»é¡Œ
â”‚   â””â”€â”€ constants/              # å¸¸é‡
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ network/               # ç¶²çµ¡å±¤
â”‚   â”œâ”€â”€ storage/               # å­˜å„²å±¤
â”‚   â”œâ”€â”€ utils/                 # å·¥å…·é¡
â”‚   â””â”€â”€ errors/                # éŒ¯èª¤è™•ç†
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ models/                # æ•¸æ“šæ¨¡å‹
â”‚   â”œâ”€â”€ repositories/          # æ•¸æ“šå€‰åº«
â”‚   â””â”€â”€ datasources/           # æ•¸æ“šæº
â”‚       â”œâ”€â”€ remote/            # é ç¨‹æ•¸æ“š
â”‚       â””â”€â”€ local/             # æœ¬åœ°æ•¸æ“š
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/              # æ¥­å‹™å¯¦é«”
â”‚   â”œâ”€â”€ usecases/              # ç”¨ä¾‹
â”‚   â””â”€â”€ repositories/          # å€‰åº«æ¥å£
â””â”€â”€ presentation/
    â”œâ”€â”€ pages/                 # é é¢
    â”‚   â”œâ”€â”€ home/
    â”‚   â”œâ”€â”€ search/
    â”‚   â”œâ”€â”€ reader/
    â”‚   â””â”€â”€ settings/
    â”œâ”€â”€ widgets/               # é€šç”¨çµ„ä»¶
    â””â”€â”€ controllers/           # æ§åˆ¶å™¨ (GetX)
```

### 5.3 æ ¸å¿ƒä¾è³´
```yaml
dependencies:
  flutter:
    sdk: flutter
  
  # ç‹€æ…‹ç®¡ç†
  get: ^4.6.5
  
  # ç¶²çµ¡
  dio: ^5.3.3
  connectivity_plus: ^5.0.1
  
  # æœ¬åœ°å­˜å„²
  hive: ^2.2.3
  hive_flutter: ^1.1.0
  shared_preferences: ^2.2.2
  path_provider: ^2.1.1
  flutter_secure_storage: ^9.0.0
  
  # åœ–ç‰‡ç·©å­˜
  cached_network_image: ^3.3.0
  
  # EPUB è™•ç†
  epub_view: ^3.1.0
  archive: ^3.4.9
  
  # UI
  flutter_screenutil: ^5.9.0
  shimmer: ^3.0.0
  loading_animation_widget: ^1.2.0
  
  # åŠŸèƒ½
  permission_handler: ^11.0.1
  url_launcher: ^6.2.1
  share_plus: ^7.2.1
  
  # å·¥å…·
  intl: ^0.18.1
  crypto: ^3.0.3
  
  # éŒ¯èª¤è¿½è¸ª
  sentry_flutter: ^7.13.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  hive_generator: ^2.0.1
  build_runner: ^2.4.6
  flutter_lints: ^3.0.0
```

---

## 6. é–‹ç™¼è·¯ç·šåœ–

### Phase 1: MVP (4-6 é€±)
**ç›®æ¨™ï¼šåŸºæœ¬å¯ç”¨çš„é–±è®€å™¨**

Week 1-2: åŸºç¤æ¶æ§‹
- [x] é …ç›®åˆå§‹åŒ–å’Œæ¶æ§‹æ­å»º
- [x] ç¶²çµ¡å±¤å’Œæ•¸æ“šå±¤å¯¦ç¾
- [x] æ›¸ç±åˆ—è¡¨é é¢ (GridView)
- [x] books.json è§£æå’Œç·©å­˜

Week 3-4: æ ¸å¿ƒåŠŸèƒ½
- [x] æ›¸ç±ä¸‹è¼‰ç®¡ç†
- [x] æœ¬åœ°å­˜å„²å¯¦ç¾
- [x] EPUB é–±è®€å™¨é›†æˆ
- [x] åŸºæœ¬é–±è®€åŠŸèƒ½ï¼ˆç¿»é ã€é€²åº¦ï¼‰

Week 5-6: å„ªåŒ–å’Œæ¸¬è©¦
- [x] éŒ¯èª¤è™•ç†
- [x] é›¢ç·šæ¨¡å¼
- [x] UI å„ªåŒ–
- [x] åŸºæœ¬æ¸¬è©¦

### Phase 2: å¢å¼·åŠŸèƒ½ (4-6 é€±)
**ç›®æ¨™ï¼šå®Œå–„ç”¨æˆ¶é«”é©—**

Week 7-8: æ›¸ç±ç®¡ç†
- [ ] æœç´¢å’Œéæ¿¾åŠŸèƒ½
- [ ] æ›¸ç±¤å’Œç­†è¨˜
- [ ] é–±è®€æ­·å²
- [ ] æœ¬åœ°æ›¸åº«ç®¡ç†

Week 9-10: é–±è®€å™¨å¢å¼·
- [ ] å­—é«”å’Œä¸»é¡Œè¨­ç½®
- [ ] é«˜äº®å’Œè¨»é‡‹
- [ ] ç›®éŒ„å°èˆª
- [ ] é–±è®€çµ±è¨ˆ

Week 11-12: æ€§èƒ½å„ªåŒ–
- [ ] åœ–ç‰‡æ‡¶åŠ è¼‰å’Œç·©å­˜
- [ ] å…§å­˜å„ªåŒ–
- [ ] éŸ¿æ‡‰å¼å¸ƒå±€
- [ ] å‹•ç•«å„ªåŒ–

### Phase 3: å®Œå–„å’Œç™¼å¸ƒ (2-4 é€±)
**ç›®æ¨™ï¼šä¸Šæ¶ Google Play**

Week 13-14: æœ€å¾Œå„ªåŒ–
- [ ] å¤šèªè¨€æ”¯æŒ
- [ ] éš±ç§æ”¿ç­–é é¢
- [ ] ç”¨æˆ¶åé¥‹æ©Ÿåˆ¶
- [ ] å®Œæ•´æ¸¬è©¦ï¼ˆåŒ…æ‹¬ä¸åŒè¨­å‚™ï¼‰

Week 15-16: ç™¼å¸ƒæº–å‚™
- [ ] æ‡‰ç”¨åœ–æ¨™å’Œå•Ÿå‹•é 
- [ ] Google Play å•†åº—è³‡æ–™æº–å‚™
- [ ] æ‡‰ç”¨ç°½åå’Œæ‰“åŒ…
- [ ] å…§éƒ¨æ¸¬è©¦ç‰ˆç™¼å¸ƒ

### Phase 4: å¾ŒçºŒè¿­ä»£ (æŒçºŒ)
**ç›®æ¨™ï¼šæ ¹æ“šç”¨æˆ¶åé¥‹å„ªåŒ–**

- [ ] é›²åŒæ­¥åŠŸèƒ½ï¼ˆå¯é¸ï¼‰
- [ ] ç¤¾å€åˆ†äº«åŠŸèƒ½
- [ ] æ›´å¤šä¸»é¡Œå’Œå­—é«”
- [ ] iOS ç‰ˆæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] å¹³æ¿å„ªåŒ–

---

## 7. é¢¨éšªå’ŒæŒ‘æˆ°

### 7.1 æŠ€è¡“é¢¨éšª
1. **EPUB è§£æè¤‡é›œæ€§**
   - é¢¨éšªï¼šä¸åŒ EPUB æ ¼å¼å…¼å®¹æ€§
   - ç·©è§£ï¼šä½¿ç”¨æˆç†Ÿçš„ epub_view åŒ…ï¼Œå……åˆ†æ¸¬è©¦

2. **æ€§èƒ½å•é¡Œ**
   - é¢¨éšªï¼šå¤§æ–‡ä»¶è™•ç†å¯èƒ½å°è‡´å…§å­˜æº¢å‡º
   - ç·©è§£ï¼šæµå¼è§£æã€åˆ†é åŠ è¼‰ã€å…§å­˜ç›£æ§

3. **ç¶²çµ¡ç©©å®šæ€§**
   - é¢¨éšªï¼šGitHub è¨ªå•å¯èƒ½ä¸ç©©å®š
   - ç·©è§£ï¼šå¯¦ç¾å®Œå–„çš„é›¢ç·šæ¨¡å¼å’Œç·©å­˜æ©Ÿåˆ¶

### 7.2 éæŠ€è¡“é¢¨éšª
1. **ç‰ˆæ¬Šå•é¡Œ**
   - é¢¨éšªï¼šæ›¸ç±ç‰ˆæ¬Šçˆ­è­°
   - ç·©è§£ï¼šæ˜ç¢ºå…è²¬è²æ˜ã€åƒ…é™å­¸ç¿’ç”¨é€”

2. **æ‡‰ç”¨å•†åº—å¯©æ ¸**
   - é¢¨éšªï¼šGoogle Play å¯èƒ½æ‹’çµ•ä¸Šæ¶
   - ç·©è§£ï¼šéµå®ˆæ‰€æœ‰æ”¿ç­–ã€æä¾›å®Œæ•´éš±ç§æ”¿ç­–

3. **ç”¨æˆ¶æœŸæœ›**
   - é¢¨éšªï¼šåŠŸèƒ½ä¸è¶³æˆ–é«”é©—ä¸ä½³
   - ç·©è§£ï¼šMVP å¿«é€Ÿè¿­ä»£ã€æ”¶é›†ç”¨æˆ¶åé¥‹

---

## 8. ç¸½çµ

é€™å€‹è¨­è¨ˆæ–¹æ¡ˆæ¶µè“‹äº†å¾ MVP åˆ°æˆç†Ÿç”¢å“çš„å®Œæ•´è·¯å¾‘ã€‚é—œéµè¦é»ï¼š

1. **å„ªå…ˆç´šæ˜ç¢º**ï¼šå…ˆå¯¦ç¾æ ¸å¿ƒé–±è®€åŠŸèƒ½ï¼Œå†é€æ­¥å¢å¼·
2. **æŠ€è¡“é¸å‹åˆç†**ï¼šä½¿ç”¨æˆç†Ÿçš„ Flutter ç”Ÿæ…‹åŒ…
3. **ç”¨æˆ¶é«”é©—å„ªå…ˆ**ï¼šé›¢ç·šæ”¯æŒã€æµæš¢å‹•ç•«ã€å‹å¥½éŒ¯èª¤æç¤º
4. **å¯æ“´å±•æ€§å¥½**ï¼šæ¶æ§‹æ¸…æ™°ï¼Œæ˜“æ–¼å¾ŒçºŒæ·»åŠ åŠŸèƒ½
5. **åˆè¦æ€§é‡è¦–**ï¼šéš±ç§ä¿è­·ã€ç‰ˆæ¬Šè²æ˜ã€æ¬Šé™ç®¡ç†

å»ºè­°å¾ Phase 1 é–‹å§‹ï¼Œå¿«é€Ÿå¯¦ç¾ MVP ä¸¦é€²è¡Œç”¨æˆ¶æ¸¬è©¦ï¼Œæ ¹æ“šåé¥‹èª¿æ•´å¾ŒçºŒé–‹ç™¼è¨ˆåŠƒã€‚
